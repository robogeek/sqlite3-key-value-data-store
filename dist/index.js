import util from 'node:util';
import sqlite3 from 'sqlite3';
import { selectors2where } from './finder.js';
// PROBLEM - @akashacms/plugns-tagged-content
// is using PouchDB which then brought in
// a lot of unwanted dependencies in the
// LevelDown arena.
//
// It should be possible to use SQLITE3 to
// implement a key/value store.  This could
// also eliminate the need for KeyV in another
// plugin.
//
// Another goal is to spin this off into its
// own package that might be of broad interest.
// Simple key/value store on SQLITE3.
// Support multiple stores - named
// Each store has its own table
// CREATE TABLE kvs${NAME} (
//    key TEXT
//    value JSON
// )
// The key column needs an index and to
// be unique
// Is there a way to ALTER TABLE to add
// columns based on a JSON field?
// To replace pouchdb use in tagged-content
// there's a need for queries on fields of
// the JSON object
// This encapsulates an object with put/get/delete
// methods for the key-value-store.
// If ALTER TABLE is useful then an API is
// needed for adding a queryable column.
// https://github.com/kujirahand/node-sqlite-kvs
// That's a simplistic KVS which can be used
// as a model
// Once this is complete it can be spun off to
// a standalone module.
// CREATE TABLE kvs{NAME} (
//     key TEXT PRIMARY KEY,
//     value JSON // isJSON=true
// ) WITHOUT ROWID;
// sqlite> SELECT 
//       vpath,
//       json_extract(info, '$.renderPath') as renderPath2 
// FROM DOCUMENTS
// WHERE renderPath2 LIKE '%index.html';
///////////////////// Create a table
export class SQ3DataStore {
    #DB;
    #tablenm;
    #indexnm;
    constructor(DB, tablenm) {
        if (typeof DB === 'object'
            && DB instanceof sqlite3.Database) {
            this.#DB = DB;
        }
        else if (typeof DB === 'string') {
            this.#DB = new sqlite3.Database(DB);
        }
        else {
            this.#DB = new sqlite3.Database(':memory:');
        }
        // this.#DB.on('trace', (sql) => {
        //     console.log(`TRACE: ${sql}`);
        // });
        this.#tablenm = tablenm;
        this.#indexnm = `kv_index_${this.#tablenm}`;
        this.#DB.exec(`
            CREATE TABLE ${this.#tablenm} (
                key TEXT PRIMARY KEY,
                value TEXT
            ) WITHOUT ROWID;
            CREATE UNIQUE INDEX ${this.#indexnm}
                ON ${this.#tablenm} (key);
        `, (err) => {
            if (err) {
                console.error(`******** Could not create database ${this.#tablenm}`);
            }
        });
    }
    get DB() { return this.#DB; }
    // This can be useful for debugging.
    // This SQLITE query retrieves the table listing
    // all the existing tables.
    // async tables() {
    //     const rows = await new Promise((resolve, reject) => {
    //         this.#DB.all(`
    //             SELECT * FROM sqlite_master;
    //         `, {},
    //         (err, rows) => {
    //             if (err) {
    //                 console.error(`put ERROR `, err.stack);
    //                 reject(err);
    //             } else {
    //                 resolve(rows);
    //             }
    //         });
    //     });
    //     return rows;
    // }
    async put(key, value) {
        // insert into ...
        // console.log(`before get ${key}`);
        const update = await this.get(key);
        // console.log(`put ${key} got value ${util.inspect(update)}`);
        if (update) {
            return this.update(key, value);
        }
        // console.log(`to put ${key}`, value);
        await new Promise((resolve, reject) => {
            this.#DB.run(`
                INSERT INTO "${this.#tablenm}"
                ( key, value )
                VALUES (
                    $key, $value
                )
            `, {
                $key: key,
                $value: JSON.stringify(value)
            }, (err) => {
                if (err) {
                    console.error(`put ERROR `, err.stack);
                    reject(err);
                }
                else {
                    resolve(undefined);
                }
            });
        });
        // console.log(`did put ${key}`);
    }
    async update(key, value) {
        // console.log(`to update ${key}`, value);
        const that = this;
        const result = await new Promise((resolve, reject) => {
            that.#DB.run(`
                UPDATE ${this.#tablenm}
                   SET value = $value
                 WHERE key = $key
            `, {
                $key: key,
                $value: JSON.stringify(value)
            }, (err) => {
                if (err) {
                    console.error(`update ERROR`, err.stack);
                    reject(err);
                }
                else
                    resolve(undefined);
            });
        });
        // console.log(`updated ${key}`);
    }
    async get(key) {
        // ... get item from table
        // console.log(`get ${key}`);
        const that = this;
        const result = await new Promise((resolve, reject) => {
            that.#DB.all(`
                SELECT value
                  FROM ${this.#tablenm}
                 WHERE key = $key
            `, {
                // $tablenm: this.#tablenm,
                $key: key
            }, (err, rows) => {
                if (err)
                    reject(err);
                else
                    resolve(rows);
            });
        });
        // console.log(`got ${key}`, result);
        if (Array.isArray(result)
            && result.length === 1) {
            const v1 = result[0];
            if (typeof v1 === 'object'
                && 'value' in v1
                && typeof v1['value'] === 'string') {
                return JSON.parse(v1['value']);
            }
            else {
                throw new Error(`Database had incorrect value field for ${key} ${util.inspect(v1)}`);
            }
        }
        else if (Array.isArray(result)
            && result.length > 1) {
            throw new Error(`Got more than one item for ${key} -- ${util.inspect(result)}`);
        }
        return undefined;
    }
    /**
     *
     * [
     *  { '$.foo.bar': 'value' },
     *  { '$.foo.bar1': 'value1' },
     *  { '$OR': [
     *     { '$.foo.zab': { gt: 'value } }
     *  ] }
     * ]
     *
     *
     * {
     *  '$.foo.bar': 'value',
     *  '$.foo.bar1': 'value1'
     *  '$.foo.bar2': { lt: 'value' },
     *  '$OR': [
     *  ]
     * }
     *
     * @param selector
     */
    async find(selectors) {
        let where = selectors2where(selectors);
        // console.log(where);
        const query = `
                SELECT key, value
                  FROM ${this.#tablenm}
                 WHERE ${where}
            `;
        // console.log(query);
        try {
            const that = this;
            const rows = await new Promise((resolve, reject) => {
                that.#DB.all(query, {}, (err, rows) => {
                    if (err)
                        reject(err);
                    else
                        resolve(rows);
                });
            });
            // console.log(`find ${util.inspect(rows)}`);
            return rows.map(row => {
                return JSON.parse(row.value);
            });
        }
        catch (err) {
            console.log(`find ERROR `, err.stack);
            throw err;
        }
    }
    async findAll() {
        const query = `
                SELECT key, value
                  FROM ${this.#tablenm}
            `;
        const that = this;
        const rows = await new Promise((resolve, reject) => {
            that.#DB.all(query, {}, (err, rows) => {
                if (err)
                    reject(err);
                else
                    resolve(rows);
            });
        });
        return rows.map(row => {
            return JSON.parse(row.value);
        });
    }
    async delete(key) {
        // .. delete item from table
        await new Promise((resolve, reject) => {
            this.#DB.run(`
                DELETE
                  FROM ${this.#tablenm}
                 WHERE key = $key
            `, {
                // $tablenm: this.#tablenm,
                $key: key
            }, (err) => {
                if (err) {
                    console.error(`delete ERROR`, err.stack);
                    reject(err);
                }
                else {
                    resolve(undefined);
                }
            });
        });
    }
    async drop() {
        // ... DROP TABLE
        await new Promise((resolve, reject) => {
            this.#DB.run(`
                DROP TABLE ${this.#tablenm}
            `, {}, (err) => {
                if (err) {
                    console.error(`delete ERROR`, err.stack);
                    reject(err);
                }
                else {
                    resolve(undefined);
                }
            });
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFDO0FBQzdCLE9BQU8sT0FBTyxNQUFNLFNBQVMsQ0FBQztBQUM5QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTlDLDZDQUE2QztBQUM3Qyx5Q0FBeUM7QUFDekMsd0NBQXdDO0FBQ3hDLG1CQUFtQjtBQUNuQixFQUFFO0FBQ0YsMENBQTBDO0FBQzFDLDJDQUEyQztBQUMzQyw4Q0FBOEM7QUFDOUMsVUFBVTtBQUNWLEVBQUU7QUFDRiw0Q0FBNEM7QUFDNUMsK0NBQStDO0FBRy9DLHFDQUFxQztBQUNyQyxrQ0FBa0M7QUFDbEMsK0JBQStCO0FBRS9CLDRCQUE0QjtBQUM1QixjQUFjO0FBQ2QsZ0JBQWdCO0FBQ2hCLElBQUk7QUFDSix1Q0FBdUM7QUFDdkMsWUFBWTtBQUVaLHVDQUF1QztBQUN2QyxpQ0FBaUM7QUFFakMsMkNBQTJDO0FBQzNDLDBDQUEwQztBQUMxQyxrQkFBa0I7QUFFbEIsa0RBQWtEO0FBQ2xELG1DQUFtQztBQUNuQywwQ0FBMEM7QUFDMUMsd0NBQXdDO0FBRXhDLGdEQUFnRDtBQUNoRCw0Q0FBNEM7QUFDNUMsYUFBYTtBQUViLDhDQUE4QztBQUM5Qyx1QkFBdUI7QUFHdkIsMkJBQTJCO0FBQzNCLDRCQUE0QjtBQUM1QixnQ0FBZ0M7QUFDaEMsbUJBQW1CO0FBR25CLGtCQUFrQjtBQUNsQixlQUFlO0FBQ2YsMkRBQTJEO0FBQzNELGlCQUFpQjtBQUNqQix3Q0FBd0M7QUFFeEMsb0NBQW9DO0FBRXBDLE1BQU0sT0FBTyxZQUFZO0lBRXJCLEdBQUcsQ0FBbUI7SUFDdEIsUUFBUSxDQUFTO0lBQ2pCLFFBQVEsQ0FBUztJQUVqQixZQUNJLEVBQTZCLEVBQzdCLE9BQWU7UUFHZixJQUFJLE9BQU8sRUFBRSxLQUFLLFFBQVE7ZUFDdEIsRUFB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QUM7cUJBQU0sQ0FBQztvQkFDSixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3ZCLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgdXRpbCBmcm9tICdub2RlOnV0aWwnO1xuaW1wb3J0IHNxbGl0ZTMgZnJvbSAnc3FsaXRlMyc7XG5pbXBvcnQgeyBzZWxlY3RvcnMyd2hlcmUgfSBmcm9tICcuL2ZpbmRlci5qcyc7XG5cbi8vIFBST0JMRU0gLSBAYWthc2hhY21zL3BsdWducy10YWdnZWQtY29udGVudFxuLy8gaXMgdXNpbmcgUG91Y2hEQiB3aGljaCB0aGVuIGJyb3VnaHQgaW5cbi8vIGEgbG90IG9mIHVud2FudGVkIGRlcGVuZGVuY2llcyBpbiB0aGVcbi8vIExldmVsRG93biBhcmVuYS5cbi8vXG4vLyBJdCBzaG91bGQgYmUgcG9zc2libGUgdG8gdXNlIFNRTElURTMgdG9cbi8vIGltcGxlbWVudCBhIGtleS92YWx1ZSBzdG9yZS4gIFRoaXMgY291bGRcbi8vIGFsc28gZWxpbWluYXRlIHRoZSBuZWVkIGZvciBLZXlWIGluIGFub3RoZXJcbi8vIHBsdWdpbi5cbi8vXG4vLyBBbm90aGVyIGdvYWwgaXMgdG8gc3BpbiB0aGlzIG9mZiBpbnRvIGl0c1xuLy8gb3duIHBhY2thZ2UgdGhhdCBtaWdodCBiZSBvZiBicm9hZCBpbnRlcmVzdC5cblxuXG4vLyBTaW1wbGUga2V5L3ZhbHVlIHN0b3JlIG9uIFNRTElURTMuXG4vLyBTdXBwb3J0IG11bHRpcGxlIHN0b3JlcyAtIG5hbWVkXG4vLyBFYWNoIHN0b3JlIGhhcyBpdHMgb3duIHRhYmxlXG5cbi8vIENSRUFURSBUQUJMRSBrdnMke05BTUV9IChcbi8vICAgIGtleSBURVhUXG4vLyAgICB2YWx1ZSBKU09OXG4vLyApXG4vLyBUaGUga2V5IGNvbHVtbiBuZWVkcyBhbiBpbmRleCBhbmQgdG9cbi8vIGJlIHVuaXF1ZVxuXG4vLyBJcyB0aGVyZSBhIHdheSB0byBBTFRFUiBUQUJMRSB0byBhZGRcbi8vIGNvbHVtbnMgYmFzZWQgb24gYSBKU09OIGZpZWxkP1xuXG4vLyBUbyByZXBsYWNlIHBvdWNoZGIgdXNlIGluIHRhZ2dlZC1jb250ZW50XG4vLyB0aGVyZSdzIGEgbmVlZCBmb3IgcXVlcmllcyBvbiBmaWVsZHMgb2Zcbi8vIHRoZSBKU09OIG9iamVjdFxuXG4vLyBUaGlzIGVuY2Fwc3VsYXRlcyBhbiBvYmplY3Qgd2l0aCBwdXQvZ2V0L2RlbGV0ZVxuLy8gbWV0aG9kcyBmb3IgdGhlIGtleS12YWx1ZS1zdG9yZS5cbi8vIElmIEFMVEVSIFRBQkxFIGlzIHVzZWZ1bCB0aGVuIGFuIEFQSSBpc1xuLy8gbmVlZGVkIGZvciBhZGRpbmcgYSBxdWVyeWFibGUgY29sdW1uLlxuXG4vLyBodHRwczovL2dpdGh1Yi5jb20va3VqaXJhaGFuZC9ub2RlLXNxbGl0ZS1rdnNcbi8vIFRoYXQncyBhIHNpbXBsaXN0aWMgS1ZTIHdoaWNoIGNhbiBiZSB1c2VkXG4vLyBhcyBhIG1vZGVsXG5cbi8vIE9uY2UgdGhpcyBpcyBjb21wbGV0ZSBpdCBjYW4gYmUgc3B1biBvZmYgdG9cbi8vIGEgc3RhbmRhbG9uZSBtb2R1bGUuXG5cblxuLy8gQ1JFQVRFIFRBQkxFIGt2c3tOQU1FfSAoXG4vLyAgICAga2V5IFRFWFQgUFJJTUFSWSBLRVksXG4vLyAgICAgdmFsdWUgSlNPTiAvLyBpc0pTT049dHJ1ZVxuLy8gKSBXSVRIT1VUIFJPV0lEO1xuXG5cbi8vIHNxbGl0ZT4gU0VMRUNUIFxuLy8gICAgICAgdnBhdGgsXG4vLyAgICAgICBqc29uX2V4dHJhY3QoaW5mbywgJyQucmVuZGVyUGF0aCcpIGFzIHJlbmRlclBhdGgyIFxuLy8gRlJPTSBET0NVTUVOVFNcbi8vIFdIRVJFIHJlbmRlclBhdGgyIExJS0UgJyVpbmRleC5odG1sJztcblxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vIENyZWF0ZSBhIHRhYmxlXG5cbmV4cG9ydCBjbGFzcyBTUTNEYXRhU3RvcmUge1xuXG4gICAgI0RCOiBzcWxpdGUzLkRhdGFiYXNlO1xuICAgICN0YWJsZW5tOiBzdHJpbmc7XG4gICAgI2luZGV4bm06IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBEQjogc3FsaXRlMy5EYXRhYmFzZSB8IHN0cmluZyxcbiAgICAgICAgdGFibGVubTogc3RyaW5nXG4gICAgKSB7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBEQiA9PT0gJ29iamVjdCdcbiAgICAgICAgICYmIERCIGluc3RhbmNlb2Ygc3FsaXRlMy5EYXRhYmFzZVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMuI0RCID0gREI7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIERCID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhpcy4jREIgPSBuZXcgc3FsaXRlMy5EYXRhYmFzZShEQik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLiNEQiA9IG5ldyBzcWxpdGUzLkRhdGFiYXNlKCc6bWVtb3J5OicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gdGhpcy4jREIub24oJ3RyYWNlJywgKHNxbCkgPT4ge1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2coYFRSQUNFOiAke3NxbH1gKTtcbiAgICAgICAgLy8gfSk7XG5cbiAgICAgICAgdGhpcy4jdGFibGVubSA9IHRhYmxlbm07XG4gICAgICAgIHRoaXMuI2luZGV4bm0gPSBga3ZfaW5kZXhfJHt0aGlzLiN0YWJsZW5tfWA7XG5cbiAgICAgICAgdGhpcy4jREIuZXhlYyhgXG4gICAgICAgICAgICBDUkVBVEUgVEFCTEUgJHt0aGlzLiN0YWJsZW5tfSAoXG4gICAgICAgICAgICAgICAga2V5IFRFWFQgUFJJTUFSWSBLRVksXG4gICAgICAgICAgICAgICAgdmFsdWUgVEVYVFxuICAgICAgICAgICAgKSBXSVRIT1VUIFJPV0lEO1xuICAgICAgICAgICAgQ1JFQVRFIFVOSVFVRSBJTkRFWCAke3RoaXMuI2luZGV4bm19XG4gICAgICAgICAgICAgICAgT04gJHt0aGlzLiN0YWJsZW5tfSAoa2V5KTtcbiAgICAgICAgYCxcbiAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYCoqKioqKioqIENvdWxkIG5vdCBjcmVhdGUgZGF0YWJhc2UgJHt0aGlzLiN0YWJsZW5tfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIGdldCBEQigpOiBzcWxpdGUzLkRhdGFiYXNlIHsgcmV0dXJuIHRoaXMuI0RCOyB9XG5cbiAgICAvLyBUaGlzIGNhbiBiZSB1c2VmdWwgZm9yIGRlYnVnZ2luZy5cbiAgICAvLyBUaGlzIFNRTElURSBxdWVyeSByZXRyaWV2ZXMgdGhlIHRhYmxlIGxpc3RpbmdcbiAgICAvLyBhbGwgdGhlIGV4aXN0aW5nIHRhYmxlcy5cblxuICAgIC8vIGFzeW5jIHRhYmxlcygpIHtcbiAgICAvLyAgICAgY29uc3Qgcm93cyA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvLyAgICAgICAgIHRoaXMuI0RCLmFsbChgXG4gICAgLy8gICAgICAgICAgICAgU0VMRUNUICogRlJPTSBzcWxpdGVfbWFzdGVyO1xuICAgIC8vICAgICAgICAgYCwge30sXG4gICAgLy8gICAgICAgICAoZXJyLCByb3dzKSA9PiB7XG4gICAgLy8gICAgICAgICAgICAgaWYgKGVycikge1xuICAgIC8vICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBwdXQgRVJST1IgYCwgZXJyLnN0YWNrKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgLy8gICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAvLyAgICAgICAgICAgICAgICAgcmVzb2x2ZShyb3dzKTtcbiAgICAvLyAgICAgICAgICAgICB9XG4gICAgLy8gICAgICAgICB9KTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gICAgIHJldHVybiByb3dzO1xuICAgIC8vIH1cblxuICAgIGFzeW5jIHB1dChrZXk6IHN0cmluZywgdmFsdWU6IGFueSlcbiAgICAgICAgOiBQcm9taXNlPHZvaWQ+XG4gICAge1xuICAgICAgICAvLyBpbnNlcnQgaW50byAuLi5cbiAgICAgICAgLy8gY29uc29sZS5sb2coYGJlZm9yZSBnZXQgJHtrZXl9YCk7XG4gICAgICAgIGNvbnN0IHVwZGF0ZSA9IGF3YWl0IHRoaXMuZ2V0KGtleSk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBwdXQgJHtrZXl9IGdvdCB2YWx1ZSAke3V0aWwuaW5zcGVjdCh1cGRhdGUpfWApO1xuICAgICAgICBpZiAodXBkYXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGUoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gY29uc29sZS5sb2coYHRvIHB1dCAke2tleX1gLCB2YWx1ZSk7XG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuI0RCLnJ1bihgXG4gICAgICAgICAgICAgICAgSU5TRVJUIElOVE8gXCIke3RoaXMuI3RhYmxlbm19XCJcbiAgICAgICAgICAgICAgICAoIGtleSwgdmFsdWUgKVxuICAgICAgICAgICAgICAgIFZBTFVFUyAoXG4gICAgICAgICAgICAgICAgICAgICRrZXksICR2YWx1ZVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIGAsIHtcbiAgICAgICAgICAgICAgICAka2V5OiBrZXksXG4gICAgICAgICAgICAgICAgJHZhbHVlOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBwdXQgRVJST1IgYCwgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KSBcbiAgICAgICAgLy8gY29uc29sZS5sb2coYGRpZCBwdXQgJHtrZXl9YCk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KVxuICAgICAgICA6IFByb21pc2U8dm9pZD5cbiAgICB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGB0byB1cGRhdGUgJHtrZXl9YCwgdmFsdWUpO1xuICAgICAgICBjb25zdCB0aGF0ID0gdGhpcztcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhhdC4jREIucnVuKGBcbiAgICAgICAgICAgICAgICBVUERBVEUgJHt0aGlzLiN0YWJsZW5tfVxuICAgICAgICAgICAgICAgICAgIFNFVCB2YWx1ZSA9ICR2YWx1ZVxuICAgICAgICAgICAgICAgICBXSEVSRSBrZXkgPSAka2V5XG4gICAgICAgICAgICBgLCB7XG4gICAgICAgICAgICAgICAgJGtleToga2V5LFxuICAgICAgICAgICAgICAgICR2YWx1ZTogSlNPTi5zdHJpbmdpZnkodmFsdWUpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgdXBkYXRlIEVSUk9SYCwgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHJlc29sdmUodW5kZWZpbmVkKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coYHVwZGF0ZWQgJHtrZXl9YCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0KGtleTogc3RyaW5nKVxuICAgICAgICA6IFByb21pc2U8YW55IHwgdW5kZWZpbmVkPlxuICAgIHtcbiAgICAgICAgLy8gLi4uIGdldCBpdGVtIGZyb20gdGFibGVcbiAgICAgICAgLy8gY29uc29sZS5sb2coYGdldCAke2tleX1gKTtcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoYXQuI0RCLmFsbChgXG4gICAgICAgICAgICAgICAgU0VMRUNUIHZhbHVlXG4gICAgICAgICAgICAgICAgICBGUk9NICR7dGhpcy4jdGFibGVubX1cbiAgICAgICAgICAgICAgICAgV0hFUkUga2V5ID0gJGtleVxuICAgICAgICAgICAgYCwge1xuICAgICAgICAgICAgICAgIC8vICR0YWJsZW5tOiB0aGlzLiN0YWJsZW5tLFxuICAgICAgICAgICAgICAgICRrZXk6IGtleVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnIsIHJvd3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUocm93cyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBnb3QgJHtrZXl9YCwgcmVzdWx0KTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KVxuICAgICAgICAgJiYgcmVzdWx0Lmxlbmd0aCA9PT0gMVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IHYxID0gcmVzdWx0WzBdO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2MSA9PT0gJ29iamVjdCdcbiAgICAgICAgICAgICAmJiAndmFsdWUnIGluIHYxXG4gICAgICAgICAgICAgJiYgdHlwZW9mIHYxWyd2YWx1ZSddID09PSAnc3RyaW5nJ1xuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodjFbJ3ZhbHVlJ10pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGFiYXNlIGhhZCBpbmNvcnJlY3QgdmFsdWUgZmllbGQgZm9yICR7a2V5fSAke3V0aWwuaW5zcGVjdCh2MSl9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpXG4gICAgICAgICAgICAmJiByZXN1bHQubGVuZ3RoID4gMVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgR290IG1vcmUgdGhhbiBvbmUgaXRlbSBmb3IgJHtrZXl9IC0tICR7dXRpbC5pbnNwZWN0KHJlc3VsdCl9YCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogXG4gICAgICogW1xuICAgICAqICB7ICckLmZvby5iYXInOiAndmFsdWUnIH0sXG4gICAgICogIHsgJyQuZm9vLmJhcjEnOiAndmFsdWUxJyB9LFxuICAgICAqICB7ICckT1InOiBbXG4gICAgICogICAgIHsgJyQuZm9vLnphYic6IHsgZ3Q6ICd2YWx1ZSB9IH1cbiAgICAgKiAgXSB9XG4gICAgICogXVxuICAgICAqIFxuICAgICAqIFxuICAgICAqIHtcbiAgICAgKiAgJyQuZm9vLmJhcic6ICd2YWx1ZScsXG4gICAgICogICckLmZvby5iYXIxJzogJ3ZhbHVlMSdcbiAgICAgKiAgJyQuZm9vLmJhcjInOiB7IGx0OiAndmFsdWUnIH0sXG4gICAgICogICckT1InOiBbXG4gICAgICogIF1cbiAgICAgKiB9XG4gICAgICogXG4gICAgICogQHBhcmFtIHNlbGVjdG9yIFxuICAgICAqL1xuICAgIGFzeW5jIGZpbmQoc2VsZWN0b3JzOiBhbnkpXG4gICAgICAgIDogUHJvbWlzZTxBcnJheTxhbnk+IHwgdW5kZWZpbmVkPlxuICAgIHtcbiAgICAgICAgbGV0IHdoZXJlID0gc2VsZWN0b3JzMndoZXJlKHNlbGVjdG9ycyk7XG5cbiAgICAgICAgLy8gY29uc29sZS5sb2cod2hlcmUpO1xuXG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgICAgICAgICAgIFNFTEVDVCBrZXksIHZhbHVlXG4gICAgICAgICAgICAgICAgICBGUk9NICR7dGhpcy4jdGFibGVubX1cbiAgICAgICAgICAgICAgICAgV0hFUkUgJHt3aGVyZX1cbiAgICAgICAgICAgIGA7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHF1ZXJ5KTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XG4gICAgICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoYXQuI0RCLmFsbChxdWVyeSwgeyB9LFxuICAgICAgICAgICAgICAgIChlcnIsIHJvd3MpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmVzb2x2ZShyb3dzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pIGFzIGFueVtdO1xuXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgZmluZCAke3V0aWwuaW5zcGVjdChyb3dzKX1gKTtcbiAgICAgICAgICAgIHJldHVybiByb3dzLm1hcChyb3cgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHJvdy52YWx1ZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyOiBhbnkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBmaW5kIEVSUk9SIGAsIGVyci5zdGFjayk7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBmaW5kQWxsKClcbiAgICAgICAgOiBQcm9taXNlPEFycmF5PGFueT4+XG4gICAge1xuXG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gYFxuICAgICAgICAgICAgICAgIFNFTEVDVCBrZXksIHZhbHVlXG4gICAgICAgICAgICAgICAgICBGUk9NICR7dGhpcy4jdGFibGVubX1cbiAgICAgICAgICAgIGA7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgICBjb25zdCByb3dzID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhhdC4jREIuYWxsKHF1ZXJ5LCB7IH0sXG4gICAgICAgICAgICAoZXJyLCByb3dzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgZWxzZSByZXNvbHZlKHJvd3MpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pIGFzIGFueVtdO1xuXG4gICAgICAgIHJldHVybiByb3dzLm1hcChyb3cgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2Uocm93LnZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZGVsZXRlKGtleTogc3RyaW5nKVxuICAgICAgICA6IFByb21pc2U8dm9pZD5cbiAgICB7XG4gICAgICAgIC8vIC4uIGRlbGV0ZSBpdGVtIGZyb20gdGFibGVcbiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy4jREIucnVuKGBcbiAgICAgICAgICAgICAgICBERUxFVEVcbiAgICAgICAgICAgICAgICAgIEZST00gJHt0aGlzLiN0YWJsZW5tfVxuICAgICAgICAgICAgICAgICBXSEVSRSBrZXkgPSAka2V5XG4gICAgICAgICAgICBgLCB7XG4gICAgICAgICAgICAgICAgLy8gJHRhYmxlbm06IHRoaXMuI3RhYmxlbm0sXG4gICAgICAgICAgICAgICAgJGtleToga2V5XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZGVsZXRlIEVSUk9SYCwgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBkcm9wKClcbiAgICAgICAgOiBQcm9taXNlPHZvaWQ+XG4gICAge1xuICAgICAgICAvLyAuLi4gRFJPUCBUQUJMRVxuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLiNEQi5ydW4oYFxuICAgICAgICAgICAgICAgIERST1AgVEFCTEUgJHt0aGlzLiN0YWJsZW5tfVxuICAgICAgICAgICAgYCwgeyB9LFxuICAgICAgICAgICAgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZGVsZXRlIEVSUk9SYCwgZXJyLnN0YWNrKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh1bmRlZmluZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59Il19